<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>点亮你的中国足迹地图</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    /* --- (所有CSS样式与上一版完全相同) --- */
    body, html { margin: 0; padding: 0; height: 100vh; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-x: hidden; }
    .page-container { display: flex; width: 90%; max-width: 1400px; height: 80vh; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
    #map-container { position: relative; flex: 3; height: 100%; min-width: 0; touch-action: none; }
    #sidebar { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-left: 1px solid #e0e0e0; background-color: #fafcfe; }
</style>
</head>
<body>
    <!-- (所有HTML结构与上一版完全相同) -->
    <div class="header-container">
        <h1>点亮你的中国足迹地图</h1>
        <p>点击地图或右侧列表中的城市，即可“点亮”或“熄灭”你的足迹。<br>所有数据将自动保存在你的浏览器中。</p>
    </div>
    <div class="page-container"><!-- ... --></div>

    <script src="https://cdn.staticfile.org/echarts/5.5.0/echarts.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const geoJsonPath = "/travel-map/city_merged.geojson";
            
            // (所有DOM元素获取与上一版完全相同)
            const myChart = echarts.init(document.getElementById('chinaMap'));
            // ...

            let cityToProvinceMap = new Map();
            let allCities = []; // 【新增】存储所有城市的列表
            let selectedCities = [];
            // ...

            // --- 核心逻辑 ---

            function loadDataFromStorage() { /* ... (不变) ... */ }
            function saveDataToStorage() { /* ... (不变) ... */ }

            // 【重大修正】现在只加载geojson文件
            fetch(geoJsonPath)
            .then(res => res.json())
            .then(geoJson => {
                loadingIndicator.style.display = 'none';
                
                // 【重大修正】从geojson中构建完整的城市-省份映射和城市列表
                if (geoJson.features) {
                    geoJson.features.forEach(feature => {
                        if (feature.properties) {
                            const cityName = feature.properties.name;
                            // GeoJSON中的"parent"属性通常包含了上级行政区信息
                            // 我们需要找到它的"name"作为省名
                            const provinceName = feature.properties.parent ? feature.properties.parent.name : '其他';
                            
                            cityToProvinceMap.set(cityName, provinceName);
                            allCities.push(cityName); // 将所有城市名存入列表
                        }
                    });
                }
                
                echarts.registerMap('china-city', geoJson);

                const baseOption = {
                    tooltip: { formatter: '{b}' },
                    visualMap: {
                        type: 'piecewise', show: false,
                        pieces: [{ value: 1, color: '#5cacec' }],
                    },
                    series: [{
                        type: 'map', map: 'china-city', roam: true, selectedMode: false,
                        itemStyle: { areaColor: '#e9f1f6', borderColor: '#b9d4e9', borderWidth: 1 },
                        emphasis: { label: { show: false }, itemStyle: { areaColor: '#E58B47' }},
                        data: []
                    }]
                };
                myChart.setOption(baseOption);

                myChart.on('click', function (params) {
                    if (params.name && cityToProvinceMap.has(params.name)) {
                        toggleCity(params.name);
                    }
                });
                
                function toggleCity(cityName) {
                    const index = selectedCities.indexOf(cityName);
                    if (index > -1) {
                        selectedCities.splice(index, 1);
                    } else {
                        selectedCities.push(cityName);
                    }
                    saveDataToStorage();
                    updateAndRender();
                }
                
                // ... (resetViewBtn, clearMapBtn 事件监听器不变) ...
                
                function updateAndRender() {
                    const keyword = searchInput.value.trim().toLowerCase();
                    // 【修正】搜索范围从已选城市改为所有城市
                    const citiesToRenderInList = keyword ? allCities.filter(name => name.toLowerCase().includes(keyword)) : allCities;

                    // 更新地图高亮（只高亮已选的）
                    myChart.setOption({ series: [{ data: selectedCities.map(name => ({ name: name, value: 1 })) }] });

                    // 更新统计（只统计已选的）
                    const cityCount = selectedCities.length;
                    if (cityCount === 0) {
                        statsCounter.textContent = '暂无足迹';
                    } else {
                        const provinceCount = new Set(selectedCities.map(name => cityToProvinceMap.get(name))).size;
                        statsCounter.textContent = `已点亮 ${provinceCount} 个省份 / ${cityCount} 座城市`;
                    }

                    // 更新侧边栏（显示所有城市，并标记已选的）
                    renderList(citiesToRenderInList);
                }

                function renderList(dataToRender) {
                    cityListContainer.innerHTML = '';
                    isAllExpanded = false;
                    expandCollapseBtn.textContent = '展开全部';

                    if (dataToRender.length === 0) {
                        cityListContainer.innerHTML = `<div style="text-align:center;color:#888;padding:20px;">未找到相关城市</div>`;
                        return;
                    }

                    const groupedByProvince = dataToRender.reduce((acc, cityName) => {
                        const province = cityToProvinceMap.get(cityName) || '未知';
                        (acc[province] = acc[province] || []).push(cityName);
                        return acc;
                    }, {});

                    const sortedProvinces = Object.keys(groupedByProvince).sort(); // 按省份字母排序
                    sortedProvinces.forEach(province => {
                        const cities = groupedByProvince[province];
                        const provinceDiv = document.createElement('div');
                        provinceDiv.className = 'province';
                        // 【修正】省份统计显示的是当前筛选结果下的城市数
                        provinceDiv.innerHTML = `<span class="province-toggle-arrow">▶</span><span>${province} (${cities.length})</span>`;
                        const citySubListDiv = document.createElement('div');
                        citySubListDiv.className = 'city-list';

                        provinceDiv.addEventListener('click', () => {
                            provinceDiv.classList.toggle('expanded');
                            citySubListDiv.style.display = provinceDiv.classList.contains('expanded') ? 'block' : 'none';
                        });

                        cities.forEach(cityName => {
                            const cityDiv = document.createElement('div');
                            cityDiv.className = 'city';
                            // 【修正】为已点亮的城市添加特殊样式
                            if (selectedCities.includes(cityName)) {
                                cityDiv.style.borderColor = '#5cacec';
                                cityDiv.style.backgroundColor = '#eaf6ff';
                            }
                            cityDiv.innerHTML = `<div class="city-name">${cityName}</div>`;
                            cityDiv.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleCity(cityName);
                            });
                            citySubListDiv.appendChild(cityDiv);
                        });
                        cityListContainer.appendChild(provinceDiv);
                        cityListContainer.appendChild(citySubListDiv);
                    });
                }
                
                // ... (expandCollapseBtn, searchInput 事件监听器不变) ...
                
                // --- 初始加载 ---
                loadDataFromStorage();
                updateAndRender();
                
                // 存储初始视图
                const initialOption = myChart.getOption();
                initialZoom = initialOption.series[0].zoom;
                initialCenter = initialOption.series[0].center;
            })
            .catch(error => {
                loadingIndicator.textContent = "地图数据加载失败，请刷新页面重试。";
                console.error("加载地图数据失败:", error);
            });
            window.addEventListener('resize', () => myChart.resize());
        });
    </script>
</body>
</html>